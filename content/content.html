<!doctype html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kanji Drill</title>
    <link rel="stylesheet" href="../css/foundation.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <script src="../js/vendor/modernizr.js"></script>

    <!-- Fav Icon -->
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
    <link rel="icon" href="../favicon.ico" type="image/x-icon">

    <link rel="apple-touch-icon" href="../img/icon_sakura.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../img/icon_sakura.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../img/icon_sakura.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../img/icon_sakura.png">
    <!-- End of Fav Icon -->
</head>
<body>

    <div class="row">
        <div class="large-12 columns">
            <h1>Quiz: Genki 1, Chapter <span id="chapterNumber"></span></h1>
        </div>
    </div>

    <div class="row">
        <div class="large-9 columns">
            <div class="panel">
                <h3>Kanji <span id="kanjiNumber"></span>/20</h3>

                <!-- Where the kanji goes to -->
                <h1 id="kanjiContent" class="text-center"></h1>

                <p>Which of the following hiragana is correct?</p>
            </div>
        </div>
        <!-- Hiragana options -->
        <div class="large-3 columns">
            <a id="alternatives01" class="button large secondary expand" role="button" href="#"></a>
            <a id="alternatives02" class="button large secondary expand" role="button" href="#"></a>
            <a id="alternatives03" class="button large secondary expand" role="button" href="#"></a>
        </div>
    </div>

    <div class="row">
        <div class="large-12 columns">
            <div class="progress">
                <span class="meter" style="width:0%;"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="large-12 columns">
            <hr />
        </div>
    </div>

    <div class="row">
        <div class="large-12 medium-12 columns">
            <h3>Recommended Chapters:</h3>

            <div class="row">
                <div class="large-4 medium-4 small-4 columns">
                    <a id="recommendedChapters01" class="button large expand" role="button" href="#">
                        <!-- Recommended Chapter, option 1 -->
                    </a>
                </div>
                <div class="large-4 medium-4 small-4 columns">
                    <a id="recommendedChapters02" class="button large expand" role="button" href="#">
                        <!-- Recommended Chapter, option 2 -->
                    </a>
                </div>
                <div class="large-4 medium-4 small-4 columns">
                    <a id="recommendedChapters03" class="button large expand" role="button" href="#">
                        <!-- Recommended Chapter, option 3 -->
                    </a>
                </div>
            </div>

        </div>
    </div>

    <div class="row">
        <div class="large-12 columns">
            <div class="panel">

            </div>
        </div>
    </div>

    <!-- Modal to show error message -->
    <div id="errorMessage" class="reveal-modal" data-reveal aria-labelledby="errorMessageTitle" aria-hidden="true" role="dialog">
        <h2 id="errorMessageTitle">Oops!</h2>
        <p>Something went wrong. No chapter was found from your request!</p>
        <p><a href="../index.html" class="button">Back</a></p>
        <a class="close-reveal-modal" aria-label="Close">&#215;</a>
    </div>
    <!-- End of modal to show error message -->

    <script src="../js/vendor/jquery.js"></script>
    <script src="../js/foundation.min.js"></script>
    <script>
        // Enable Foundation
        $(document).foundation();

        // Final variables
        var NUMBER_QUESTIONS = 20,
            PARAM_CHAPTER = "chapter";

        // Global variables
        var index = 1,
            classButton = "";
        // var number = 1 + Math.floor(Math.random() * 2);

        // Fetch chapter number from URL (necessary)
        var jsonFile = "../js/json/"; // file to fetch data
        (function(){
            jsonFile += "chapter"+ getUrlParameter(PARAM_CHAPTER) +"."+ "json";
        })(jQuery)

        // Fetch data from JSON file
        var json = ""; // returned value from JSON file
        $.getJSON( jsonFile, function( jsonResult ) {

            // sort/shuffle/randomize here <---->
            json = jsonResult;

            // initialize page basic structure - once
            initialize(index);

            // initialize questions and alternatives - first time
            updateQuestion(index);
        })
        // if there isn't any file, reveal the error message dialog
        .fail(function() {
            $('#errorMessage').foundation('reveal', 'open');
        });

        // When the dialog is closed, redirect user to main page.
        $('a.close-reveal-modal').click(function() {
            window.location.replace("../index.html");
        });

        /*
         * Sort questions randomly.
         */
        function shuffle(indexes) {
            var j, x;

            for(var i = indexes.length; i; ) {
                j = parseInt(Math.random() * i);
                x = indexes[--i];
                indexes[i] = indexes[j];
                indexes[j] = x;
            }
            return indexes;
        }

        /*
         * updates ("grows") the progress bar regarding the
         * number of questions.
         */
        function setProgress(index) {
            $(".meter").animate({
                width: (index/NUMBER_QUESTIONS)*100 + "%"
            }, 1500);
        }

        /*
         * Updates what depends from json file, but it's
         * executed only once. Any recall from this function
         * is unnecessary.
         */
        function initialize(index) {
            // Add chapter number at the h1 title
            $("#chapterNumber").text(json.chapter);

            // Add recommended chapters below to question
            $.each(json.recommendedChapters, function( i, value ) {
                //remember that indexes start with 0 as value!
                $("#recommendedChapters0" + (++i)).text("Chapter " + value);
            });

            $("#alternatives01").addClass("correct");
            $("#alternatives02").addClass("incorrect");
            $("#alternatives03").addClass("incorrect");

            // Action for correct answer
            $(".correct").click(function() {
                // Shows that is a correct answer
                $(this).removeClass("secondary").addClass("success");

                // "Refresh" page
                window.setTimeout(updateQuestion, 2000, (++index));
            });

            // Action for wrong answer
            $(".incorrect").click(function() {
                // Shows that is an incorrect answer
                $(this).removeClass("secondary").addClass("alert");
                // Shows the correct answer
                $(".correct").removeClass("secondary").addClass("success");

                // "Refresh" page. The delay is to show the correct answer to
                // user.
                // TODO: add score parameter
                window.setTimeout(updateQuestion, 2000, (++index));
            });
        }

        /*
         * Changes the question/alternatives everytime the user
         * answers.
         */
        function updateQuestion(index) {
            if(index <= NUMBER_QUESTIONS) {
                // Set progress bar ("meter" class)
                setProgress(index);

                $("#kanjiNumber").text(index);

                // Add kanji to question
                $("#kanjiContent").text(json.data[index-1].kanji);

                // Adding hiragana to each option. If randomize them doesn't work
                // try to append to <div> the entire <a> tag button
                $("#alternatives01").text(json.data[index-1].correctHiragana).removeClass("alert success").addClass("secondary");
                $("#alternatives02").text(json.data[index-1].alternatives[0]).removeClass("alert success").addClass("secondary");
                $("#alternatives03").text(json.data[index-1].alternatives[1]).removeClass("alert success").addClass("secondary");
            } else {
                // redirects to results page
                window.location.href="gameover.html";
            }
        }

        /*
         * Fetch, from URL params, the chapter number.
         */
        function getUrlParameter(sParam) {
            var sPageURL = window.location.search.substring(1);
            var sURLVariables = sPageURL.split('&');
            for (var i = 0; i < sURLVariables.length; i++)
            {
                var sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] == sParam)
                {
                    return sParameterName[1];
                }
            }
        }
    </script>
</body>
</html>
